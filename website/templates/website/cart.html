{% extends 'website/base.html' %}
{% load static %}

{% block title %}Shopping Cart - Fieldmax{% endblock %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .cart-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
        background-size: 400% 400%;
        animation: gradientShift 20s ease infinite;
        padding: 40px 5%;
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .cart-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 50px;
        color: #fff;
    }

    .page-header h1 {
        font-size: clamp(32px, 5vw, 56px);
        font-weight: 900;
        margin-bottom: 15px;
        text-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .page-header p {
        font-size: 18px;
        opacity: 0.95;
    }

    .cart-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
        align-items: start;
    }

    .cart-items {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(30px);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .empty-cart {
        text-align: center;
        padding: 80px 30px;
    }

    .empty-cart-icon {
        font-size: 100px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-cart h3 {
        font-size: 28px;
        font-weight: 700;
        color: #1a1f2e;
        margin-bottom: 15px;
    }

    .empty-cart p {
        color: #6b7280;
        font-size: 16px;
        margin-bottom: 30px;
    }

    .cart-item {
        display: grid;
        grid-template-columns: 100px 1fr auto;
        gap: 20px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .cart-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        border-color: #667eea;
    }

    .item-image {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
    }

    .item-details {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 8px;
    }

    .item-name {
        font-size: 20px;
        font-weight: 700;
        color: #1a1f2e;
    }

    .item-price {
       font-size: 24px;
       font-weight: 900;
       background: linear-gradient(135deg, #667eea, #764ba2);

       background-clip: text;            /* Standard */
       -webkit-background-clip: text;    /* Chrome, Safari */

       -webkit-text-fill-color: transparent;
    }


    .item-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: space-between;
        gap: 15px;
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #fff;
        border-radius: 50px;
        padding: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .qty-btn {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qty-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
    }

    .qty-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .qty-display {
        font-size: 18px;
        font-weight: 700;
        color: #1a1f2e;
        min-width: 35px;
        text-align: center;
    }

    .remove-btn {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 2px solid #ef4444;
        padding: 8px 20px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .remove-btn:hover {
        background: #ef4444;
        color: #fff;
        transform: scale(1.05);
    }

    .cart-summary {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(30px);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        position: sticky;
        top: 120px;
    }

    .summary-title {
        font-size: 24px;
        font-weight: 900;
        color: #1a1f2e;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        font-size: 16px;
        color: #6b7280;
    }

    .summary-row.total {
        font-size: 28px;
        font-weight: 900;
        color: #1a1f2e;
        margin-top: 15px;
        padding-top: 20px;
        border-top: 2px solid #e5e7eb;
    }

    .summary-row .value {
        font-weight: 700;
        color: #1a1f2e;
    }

    .checkout-btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 25px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .checkout-btn:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.7);
    }

    .checkout-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .continue-shopping {
        width: 100%;
        padding: 15px;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(20px);
        color: #fff;
        border: 2px solid rgba(255,255,255,0.4);
        border-radius: 50px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 15px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-decoration: none;
    }

    .continue-shopping:hover {
        background: rgba(255,255,255,0.25);
        border-color: rgba(255,255,255,0.6);
        transform: translateY(-3px);
        color: #fff;
    }

    .single-item-badge {
        display: inline-block;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 700;
        margin-top: 5px;
    }

    .alert {
        padding: 15px 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
    }

    .alert-warning {
        background: rgba(251, 191, 36, 0.1);
        color: #b45309;
        border: 2px solid #fbbf24;
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        color: #b91c1c;
        border: 2px solid #ef4444;
    }

    .loading {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: #1a1f2e;
    }

    @media (max-width: 1024px) {
        .cart-grid {
            grid-template-columns: 1fr;
        }

        .cart-summary {
            position: static;
        }
    }

    @media (max-width: 768px) {
        .cart-item {
            grid-template-columns: 80px 1fr;
            gap: 15px;
        }

        .item-image {
            width: 80px;
            height: 80px;
            font-size: 36px;
        }

        .item-actions {
            grid-column: 2;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h1 {
            font-size: 32px;
        }
    }
</style>

<div class="cart-page">
    <div class="cart-container">
        <div class="page-header">
            <h1>üõí Shopping Cart</h1>
            <p>Review your items before checkout</p>
        </div>

        <div id="cartAlerts"></div>

        <div class="cart-grid">
            <div class="cart-items">
                <div id="cartItemsContainer">
                    <div class="loading">Loading your cart...</div>
                </div>
            </div>

            <div class="cart-summary">
                <h3 class="summary-title">Order Summary</h3>
                <div class="summary-row">
                    <span>Items:</span>
                    <span class="value" id="itemCount">0</span>
                </div>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span class="value" id="subtotal">KSh 0</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="total">KSh 0</span>
                </div>
                <button class="checkout-btn" id="checkoutBtn" onclick="proceedToCheckout()">
                    <span>üîí</span>
                    <span>CHECKOUT</span>
                </button>
                <a href="{% url 'home' %}" class="continue-shopping">
                    <span>‚Üê</span>
                    <span>Continue Shopping</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    let cart = [];

    // Load and validate cart
    async function loadCart() {
        try {
            // Get cart from localStorage
            const localCart = JSON.parse(localStorage.getItem('fieldmax_cart') || '[]');
            
            if (localCart.length === 0) {
                showEmptyCart();
                return;
            }

            // Validate cart with backend
            const response = await fetch('/api/validate-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ cart: localCart })
            });

            const data = await response.json();

            if (data.success) {
                cart = data.items;
                
                // Update localStorage with validated cart
                localStorage.setItem('fieldmax_cart', JSON.stringify(cart));
                
                // Show warnings if any
                if (data.errors && data.errors.length > 0) {
                    showAlerts(data.errors, 'warning');
                }
                
                renderCart();
                updateSummary();
            } else {
                showError(data.message || 'Failed to load cart');
            }
        } catch (error) {
            console.error('Error loading cart:', error);
            showError('Failed to load cart. Please try again.');
        }
    }

    // Render cart items
    function renderCart() {
        const container = document.getElementById('cartItemsContainer');
        
        if (cart.length === 0) {
            showEmptyCart();
            return;
        }

        container.innerHTML = cart.map(item => `
            <div class="cart-item" data-id="${item.id}">
                <div class="item-image">
                    <span>${getEmojiForProduct(item.name)}</span>
                </div>
                <div class="item-details">
                    <div class="item-name">${item.name}</div>
                    ${item.is_single_item ? '<div class="single-item-badge">SINGLE ITEM</div>' : ''}
                    <div class="item-price">KSh ${item.price.toLocaleString()}</div>
                    ${item.old_price ? `<small style="color: #ef4444;">Price updated: KSh ${item.old_price.toLocaleString()}</small>` : ''}
                </div>
                <div class="item-actions">
                    <div class="quantity-control">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, -1)" ${item.is_single_item || item.quantity <= 1 ? 'disabled' : ''}>
                            ‚àí
                        </button>
                        <span class="qty-display">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 1)" ${item.is_single_item || item.quantity >= item.max_quantity ? 'disabled' : ''}>
                            +
                        </button>
                    </div>
                    <button class="remove-btn" onclick="removeItem(${item.id})">
                        <span>üóëÔ∏è</span>
                        <span>Remove</span>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Show empty cart
    function showEmptyCart() {
        const container = document.getElementById('cartItemsContainer');
        container.innerHTML = `
            <div class="empty-cart">
                <div class="empty-cart-icon">üõí</div>
                <h3>Your cart is empty</h3>
                <p>Add some products to get started!</p>
                <a href="{% url 'home' %}" class="checkout-btn" style="max-width: 300px; margin: 0 auto;">
                    <span>üõçÔ∏è</span>
                    <span>START SHOPPING</span>
                </a>
            </div>
        `;
        updateSummary();
    }

    // Update quantity
    function updateQuantity(productId, change) {
        const item = cart.find(i => i.id === productId);
        if (!item) return;

        const newQty = item.quantity + change;
        
        if (newQty < 1 || newQty > item.max_quantity) return;
        if (item.is_single_item && newQty > 1) return;

        item.quantity = newQty;
        item.subtotal = item.price * item.quantity;

        // Update localStorage
        localStorage.setItem('fieldmax_cart', JSON.stringify(cart));
        
        // Re-render
        renderCart();
        updateSummary();
    }

    // Remove item
    function removeItem(productId) {
        if (!confirm('Remove this item from cart?')) return;

        cart = cart.filter(item => item.id !== productId);
        localStorage.setItem('fieldmax_cart', JSON.stringify(cart));
        
        renderCart();
        updateSummary();
        
        if (cart.length === 0) {
            showEmptyCart();
        }
    }

    // Update summary
    function updateSummary() {
        const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
        const total = cart.reduce((sum, item) => sum + item.subtotal, 0);

        document.getElementById('itemCount').textContent = itemCount;
        document.getElementById('subtotal').textContent = `KSh ${total.toLocaleString()}`;
        document.getElementById('total').textContent = `KSh ${total.toLocaleString()}`;

        const checkoutBtn = document.getElementById('checkoutBtn');
        checkoutBtn.disabled = cart.length === 0;
    }

    // Proceed to checkout
    function proceedToCheckout() {
        if (cart.length === 0) return;
        
        // Redirect to checkout page
        window.location.href = '{% url "checkout" %}';
    }

    // Show alerts
    function showAlerts(messages, type = 'warning') {
        const container = document.getElementById('cartAlerts');
        const alertClass = type === 'warning' ? 'alert-warning' : 'alert-error';
        
        container.innerHTML = messages.map(msg => `
            <div class="alert ${alertClass}">
                <span>${type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}</span>
                <span>${msg}</span>
            </div>
        `).join('');
    }

    function showError(message) {
        showAlerts([message], 'error');
    }

    // Get emoji for product
    function getEmojiForProduct(name) {
        const lowerName = name.toLowerCase();
        if (lowerName.includes('phone') || lowerName.includes('mobile')) return 'üì±';
        if (lowerName.includes('headphone') || lowerName.includes('earphone')) return 'üéß';
        if (lowerName.includes('watch')) return '‚åö';
        if (lowerName.includes('cable') || lowerName.includes('charger')) return 'üîå';
        if (lowerName.includes('screen') || lowerName.includes('protector')) return 'üõ°Ô∏è';
        return 'üì¶';
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadCart();
    });

    // Make functions global
    window.updateQuantity = updateQuantity;
    window.removeItem = removeItem;
    window.proceedToCheckout = proceedToCheckout;
</script>

{% endblock %}